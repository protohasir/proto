syntax = "proto3";

package user.v1;

import "buf/validate/validate.proto";
import "google/protobuf/empty.proto";
import "shared/filter.proto";

message RegisterRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string username = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 10
  ];
  string password = 3 [
    (buf.validate.field).string.min_len = 8,
    (buf.validate.field).string.max_len = 20
  ];
}

message LoginRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string password = 2 [
    (buf.validate.field).string.min_len = 8,
    (buf.validate.field).string.max_len = 20
  ];
}

message TokenEnvelope {
  string access_token = 1;
  string refresh_token = 2;
}

message RenewTokensRequest {
  string refresh_token = 1 [(buf.validate.field).required = true];
}

message RenewTokensResponse {
  string access_token = 1;
}

message ForgotPasswordRequest {
  string email = 1 [(buf.validate.field).string.email = true];
}

message ResetPasswordRequest {
  string token = 1 [(buf.validate.field).required = true];
  string new_password = 2 [
    (buf.validate.field).string.min_len = 8,
    (buf.validate.field).string.max_len = 20
  ];
}

message UpdateUserRequest {
  string password = 1 [
    (buf.validate.field).string.min_len = 8,
    (buf.validate.field).string.max_len = 20
  ];
  optional string username = 2;
  optional string email = 3 [(buf.validate.field).string.email = true];
  optional string new_password = 4 [
    (buf.validate.field).string.min_len = 8,
    (buf.validate.field).string.max_len = 20
  ];
}

message CreateApiKeyRequest {
  string name = 1 [(buf.validate.field).string.min_len = 1];
}

message CreateApiKeyResponse {
  string key = 1;
}

message CreateSshKeyRequest {
  string name = 1 [(buf.validate.field).string.min_len = 1];
  string public_key = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.max_len = 2048,
    (buf.validate.field).string.pattern = "^(ssh-rsa|ecdsa-sha2-nistp256|ecdsa-sha2-nistp384|ecdsa-sha2-nistp521|ssh-ed25519|sk-ecdsa-sha2-nistp256@openssh\\.com|sk-ssh-ed25519@openssh\\.com) "
  ];
}

message Key {
  string id = 1;
  string name = 2;
}

message KeyResponse {
  repeated Key keys = 1;
  int32 next_page = 2;
  int32 total_page = 3;
}

message RevokeKeyRequest {
  string id = 1 [(buf.validate.field).required = true];
}

service UserService {
  rpc Register(RegisterRequest) returns (google.protobuf.Empty);
  rpc Login(LoginRequest) returns (TokenEnvelope);
  rpc RenewTokens(RenewTokensRequest) returns (RenewTokensResponse);
  rpc ForgotPassword(ForgotPasswordRequest) returns (google.protobuf.Empty);
  rpc ResetPassword(ResetPasswordRequest) returns (google.protobuf.Empty);
  rpc UpdateUser(UpdateUserRequest) returns (TokenEnvelope);
  rpc DeleteAccount(google.protobuf.Empty) returns (google.protobuf.Empty);
  rpc CreateApiKey(CreateApiKeyRequest) returns (CreateApiKeyResponse);
  rpc GetApiKeys(shared.Pagination) returns (KeyResponse);
  rpc RevokeApiKey(RevokeKeyRequest) returns (google.protobuf.Empty);
  rpc CreateSshKey(CreateSshKeyRequest) returns (google.protobuf.Empty);
  rpc GetSshKeys(shared.Pagination) returns (KeyResponse);
  rpc RevokeSshKey(RevokeKeyRequest) returns (google.protobuf.Empty);
}
